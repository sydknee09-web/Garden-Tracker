# Garden Tracker — App Audit (Feb 2025)

This document summarizes an audit of the codebase against the **Laws of the Vault**, multi-tenancy, and general soundness. Fixes applied during the audit are noted; remaining recommendations are listed for your backlog.

---

## Summary

- **Laws 1 (RLS/user_id), 2 (soft delete), 4 (image compression), 9 (entry_type), 10 (profile type)** were checked across API routes and components.
- **Fixes applied:** Multiple `deleted_at` filters were missing on fetches for `plant_profiles`, `seed_packets`, `journal_entries`, and `grow_instances`. These have been added so trashed items are excluded from lists and exports.
- **No broken imports** from deleted files (`plant-profiles` route, `scheduleDefaults`, `settings/brain`) were found.
- **Recommendations** below are non-blocking improvements (server-side image compression, offline queue safety, and a few optional filters).

---

## Law 1: RLS & User ID

**Status: Compliant**

- **API routes:** `batch-import`, `import-logs`, `merge-profiles`, and other auth-backed routes use `user.id` from `getUser(token)` and pass `user_id` on inserts/updates.
- **Client-side:** `generateCareTasks`, `completeSowTask`, and component inserts (tasks, journal, grow_instances, care_schedules) include `user_id`.
- **CareScheduleManager** and **vault/plant** task creation both pass `user_id` in payloads.

No violations found.

---

## Law 2: Soft Delete

**Status: Compliant (after fixes)**

**Required behavior:**  
`plant_profiles`, `seed_packets`, `journal_entries`, `grow_instances`, and `tasks` must use soft delete (`update({ deleted_at })`), and all fetches must use `.is("deleted_at", null)` unless intentionally including trash (e.g. Developer trash view).

**Fixes applied:**

- **Vault profile [id]:** Journal entries (main list, per-packet list, journal photos) now filter `.is("deleted_at", null)`.
- **Vault review-import:** Profile match list now filters plant_profiles by `deleted_at`.
- **Vault history:** Harvest count query on journal_entries now filters `deleted_at`.
- **Vault packets:** Profile name lookup now filters plant_profiles by `deleted_at`.
- **BatchAddSeed / QuickAddSeed:** Profile and packet lists for suggestions now filter by `deleted_at`.
- **Vault tags:** Tag aggregation and “remove tag from all” queries now filter plant_profiles and seed_packets by `deleted_at`.
- **MyPlantsView:** Journal entries query now filters by `deleted_at`.
- **Journal page:** Both profile name lookups now filter plant_profiles by `deleted_at`.
- **Settings profile export:** Export now excludes trashed rows for all five tables so exports don’t re-import deleted data.

**Hard deletes (intentional):**

- **Developer Settings → permanent delete:** `plant_profiles.delete()` is used only for “permanent trash purge” as allowed by Law 2.
- **Vault page:** Fallback `plant_varieties.delete()` for legacy table only (not in the five protected tables).
- **Extract cache, import logs, tag_settings, blocked_tags:** Config/cache tables; hard delete is acceptable.

**Offline queue:**  
`OfflineIndicator` replays queued operations including generic `delete()`. If the queue ever stored a raw delete for one of the five protected tables, replay would hard-delete. Recommendation: ensure the app only enqueues **updates** (e.g. `{ deleted_at: now }`) for those tables, not table `delete` operations.

---

## Law 3: Seed Packet Volume

**Status: Compliant**

- `qty_status` is used as a numeric percentage (0–100) everywhere (slider, decrement, archive at 0).
- Packet archival and profile `out_of_stock` / shopping list logic are implemented in `completeSowTask` and vault flows.

No issues found.

---

## Law 4: Image Compression

**Status: Compliant (client); one server gap**

- All **client-side** upload paths (vault [id], review-import, import, BatchAddSeed, garden, FeedbackModal, AddPlantModal, journal, journal/new, HarvestModal) use `compressImage()` before uploading.
- **Exception:** `api/seed/batch-import/route.ts` uploads images from a proxied URL without server-side compression (there is a TODO in code). Recommendation: add server-side compression (e.g. `sharp`) for batch-import image uploads to align with Law 4 for server paths.

---

## Law 5: Smart Camera

Not audited in this pass (would require checking `capture="environment"` and `getUserMedia` usage in camera UI).

---

## Law 6: 11 Functional Tags

Tagging logic is present in parser and QuickAdd; no removal of the 11 functional tags was found.

---

## Law 7: Plant Profile Image Hierarchy

Hero image fallback chain (hero_image_url → hero_image_path → journal photo → packet image → emoji) is implemented in the codebase.

---

## Law 8: Source URL Preservation

`source_url` / `purchase_url` are set when importing from URLs (batch-import, import flows).

---

## Law 9: Entry Types Explicit

All journal inserts checked set `entry_type` explicitly (`planting`, `growth`, `harvest`, `note`, `care`, `quick`, `death`, etc.). No reliance on inferring type from note text for new entries.

---

## Law 10 & 11: Profile Type / Care Schedule

Profile type (`seed` vs `permanent`) and care schedule architecture (templates vs instance schedules, task generation) are used as intended.

---

## Deleted Files & References

- **Removed routes/pages:** `api/garden/plant-profiles/route.ts`, `lib/scheduleDefaults.ts`, `settings/brain/page.tsx`.
- **Check:** No remaining imports or links to these were found. Settings nav no longer references “brain”.

---

## Additional Recommendations

1. **Server-side image compression (batch-import)**  
   In `api/seed/batch-import/route.ts`, add compression (e.g. `sharp`) for the blob from `proxy-image` before uploading to storage.

2. **Offline queue and deletes**  
   Ensure only soft-delete updates are enqueued for `plant_profiles`, `seed_packets`, `journal_entries`, `grow_instances`, and `tasks`; avoid enqueuing raw `delete` for these tables.

3. **Home/Calendar name resolution**  
   Task and shopping list name resolution on the home page fetches `plant_profiles` by id without `.is("deleted_at", null)`. That was left as-is so names for tasks tied to since-deleted profiles still show (e.g. “Tomato” instead of “Unknown”). If you prefer to hide trashed profile names, add `.is("deleted_at", null)` to those selects and accept “Unknown” for deleted profiles.

4. **generateCareTasks — tasks check**  
   The “existing task for this schedule” check does not filter by `deleted_at`. That’s acceptable: it avoids creating duplicate tasks when an old one was soft-deleted. Optional: add `.is("deleted_at", null)` if you want to allow a new task when the previous one was deleted.

---

## Files Touched (Fixes)

- `src/app/vault/[id]/page.tsx` — journal_entries and journal photos `deleted_at` filters.
- `src/app/vault/review-import/page.tsx` — plant_profiles `deleted_at` filter.
- `src/app/vault/history/page.tsx` — journal_entries `deleted_at` filter.
- `src/app/vault/packets/page.tsx` — plant_profiles `deleted_at` filter.
- `src/components/BatchAddSeed.tsx` — plant_profiles `deleted_at` filter.
- `src/components/QuickAddSeed.tsx` — plant_profiles and seed_packets `deleted_at` filters (two places).
- `src/app/vault/tags/page.tsx` — plant_profiles and seed_packets `deleted_at` filters (two places).
- `src/components/MyPlantsView.tsx` — journal_entries `deleted_at` filter.
- `src/app/journal/page.tsx` — plant_profiles `deleted_at` filters (two places).
- `src/app/settings/profile/page.tsx` — export queries for all five protected tables now use `deleted_at` filter.

---

*Audit performed against the Laws of the Vault and codebase as of Feb 2025.*
